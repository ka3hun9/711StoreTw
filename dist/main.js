import*as a from"fs";import*as e from"path";import t from"axios";import n from"axios-retry";import o from"qs";import{XMLParser as r}from"fast-xml-parser";n(t,{retries:3});let s="",i="",c="";const d=[["15","台南市"],["17","高雄市"],["19","屏東縣"],["20","宜蘭縣"],["21","花蓮縣"],["22","台東縣"],["23","澎湖縣"],["24","連江縣"],["25","金門縣"]].map((a=>({label:a[1],value:a[1],state:a[1],serial:a[0],children:[]})));async function m(a,{serial:e,state:t,town:n,road:o}){let r=null;switch(!0){case!!o:console.warn(`开始获取 ${t} - ${n} - ${o} 的店铺地址`),r=await async function(a,e,t){const n={commandid:"SearchStore",city:a,town:e,roadname:t,ID:"",StoreName:"",SpecialStore_Kind:"",leftMenuChecked:"",address:""};return await l(n,"GeoPosition",(a=>({label:`<${a.POIName}> ${a.Address}`,value:`<${a.POIName}> ${a.Address}`})))}(t,n,o);break;case!!n:console.warn(`开始获取 ${t} - ${n} 的街道`),r=await async function(a,e){const t={commandid:"SearchRoad",city:a,town:e,ID:"",StoreName:"",SpecialStore_Kind:"",leftMenuChecked:""};return await l(t,"RoadName",(a=>({label:a.rd_name_1+a.section_1,value:a.rd_name_1+a.section_1,road:a.rd_name_1+a.section_1,children:[]})))}(t,n);break;case!!e:console.warn(`开始获取 ${t} 的下属地区`),r=await async function(a){const e={commandid:"GetTown",cityid:a,leftMenuChecked:""};return await l(e,"GeoPosition",(a=>({label:a.TownName,value:a.TownName,town:a.TownName,children:[]})))}(e)}return r&&(a.children=r),r}function l(a,e,n){return new Promise((s=>{setTimeout((async()=>{const{status:i,data:c}=await t.post("https://emap.pcsc.com.tw/EMapSDK.aspx",o.stringify(a));if(200!==i)throw new Error(`${e} 请求错误.`);{const a=(new r).parse(c).iMapSDKOutput[e];Array.isArray(a)?s(a.map(n)):s(a?[n(a)]:[])}}),2e3)}))}(function t(n){let o=n.map(((n,r)=>async function(){s=n.state?n.state:s,i=n.state?"":n.town?n.town:i,c=n.state||n.town?"":n.road?n.road:c;const l=o[++r],w=await m(n,{serial:n.serial,state:s,town:i,road:c});w[0]&&void 0!==w[0].children&&await t(w)[0](),l?await l():a.writeFileSync(e.resolve(process.cwd(),`./dist/${s}.json`),JSON.stringify(d))}));return o})(d)[0]();
