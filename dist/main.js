import*as a from"fs";import*as e from"path";import t from"axios";import o from"axios-retry";import n from"qs";import{XMLParser as r}from"fast-xml-parser";import{isUndefined as i}from"lodash-es";o(t,{retries:3});let s="",c="",d="";const m=[["22","台東縣"],["23","澎湖縣"],["24","連江縣"],["25","金門縣"]].map((a=>({label:a[1],value:a[1],state:a[1],serial:a[0],children:[]})));async function l(a,{serial:e,state:t,town:o,road:n}){let r=null;switch(!0){case!i(n):console.warn(`开始获取 ${t} - ${o} - ${n} 的店铺地址`),r=await async function(a,e,t){const o={commandid:"SearchStore",city:a,town:e,roadname:t,ID:"",StoreName:"",SpecialStore_Kind:"",leftMenuChecked:"",address:""};return await w(o,"GeoPosition",(a=>({label:`<${a.POIName}> ${a.Address}`,value:`<${a.POIName}> ${a.Address}`})))}(t,o,n);break;case!i(o):console.warn(`开始获取 ${t} - ${o} 的街道`),r=await async function(a,e){const t={commandid:"SearchRoad",city:a,town:e,ID:"",StoreName:"",SpecialStore_Kind:"",leftMenuChecked:""};return await w(t,"RoadName",(a=>({label:a.rd_name_1+a.section_1,value:a.rd_name_1+a.section_1,road:a.rd_name_1+a.section_1,children:[]})))}(t,o);break;case!i(e):console.warn(`开始获取 ${t} 的下属地区`),r=await async function(a){const e={commandid:"GetTown",cityid:a,leftMenuChecked:""};return await w(e,"GeoPosition",(a=>({label:a.TownName,value:a.TownName,town:a.TownName,children:[]})))}(e)}return r&&(a.children=r),r}function w(a,e,o){return new Promise((i=>{setTimeout((async()=>{const{status:s,data:c}=await t.post("https://emap.pcsc.com.tw/EMapSDK.aspx",n.stringify(a));if(200!==s)throw new Error(`${e} 请求错误.`);{const a=(new r).parse(c),t=a.iMapSDKOutput[e];Array.isArray(t)?i(t.map(o)):i(t?[o(t)]:[])}}),2e3)}))}(function t(o){let n=o.map(((o,r)=>async function(){s=i(o.state)?s:o.state,c=i(o.state)?o.town?o.town:c:void 0,d=i(o.state)&&i(o.town)?i(o.road)?d:o.road:void 0;const w=n[++r],u=await l(o,{serial:o.serial,state:s,town:c,road:d});u[0]&&void 0!==u[0].children&&await t(u)[0](),w?await w():a.writeFileSync(e.resolve(process.cwd(),`./dist/${s}.json`),JSON.stringify(m))}));return n})(m)[0]();
